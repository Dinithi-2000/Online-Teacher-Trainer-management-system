<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Management - EduMentor Pro Admin</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="admin-body">
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="admin-header-content">
            <div class="admin-brand">
                <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                    <i class="fas fa-bars"></i>
                </button>
                <i class="fas fa-shield-alt"></i>
                <span class="brand-text">EduMentor Pro</span>
                <span class="admin-badge">Admin</span>
            </div>
            
            <div class="header-search">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search contacts..." id="globalSearch">
                </div>
            </div>
            
            <div class="header-actions">
                <button class="notification-btn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                
                <div class="admin-profile" id="adminProfile">
                    <img src="../assets/images/admin-avatar.jpg" alt="Admin" class="admin-avatar" id="adminAvatar">
                    <div class="admin-details">
                        <span class="admin-name" id="adminName">John Admin</span>
                        <span class="admin-role" id="adminRole">Super Admin</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                    
                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header">
                            <img src="../assets/images/admin-avatar.jpg" alt="Admin" class="dropdown-avatar">
                            <div>
                                <h4 id="dropdownName">John Admin</h4>
                                <p id="dropdownEmail">admin@edumentor.com</p>
                            </div>
                        </div>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item">
                                <i class="fas fa-user"></i> Profile Settings
                            </a>
                            <a href="#" class="dropdown-item">
                                <i class="fas fa-cog"></i> Preferences
                            </a>
                            <a href="#" class="dropdown-item">
                                <i class="fas fa-question-circle"></i> Help Center
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h3>Main</h3>
                    <ul>
                        <li><a href="index.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a></li>
                        <li><a href="analytics.html" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </a></li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <h3>Content Management</h3>
                    <ul>
                        <li><a href="courses.html" class="nav-link">
                            <i class="fas fa-book"></i>
                            <span>Courses</span>
                            <span class="nav-badge">24</span>
                        </a></li>
                        <li><a href="trainers.html" class="nav-link">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Trainers</span>
                            <span class="nav-badge">12</span>
                        </a></li>
                        <li><a href="blog.html" class="nav-link">
                            <i class="fas fa-blog"></i>
                            <span>Blog Posts</span>
                        </a></li>
                        <li><a href="resources.html" class="nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Resources</span>
                        </a></li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <h3>User Management</h3>
                    <ul>
                        <li><a href="users.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                            <span class="nav-badge">1.2k</span>
                        </a></li>
                        <li><a href="enrollments.html" class="nav-link">
                            <i class="fas fa-user-graduate"></i>
                            <span>Enrollments</span>
                        </a></li>
                        <li><a href="contacts.html" class="nav-link active">
                            <i class="fas fa-envelope"></i>
                            <span>Contact Messages</span>
                            <span class="nav-badge">15</span>
                        </a></li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <h3>System</h3>
                    <ul>
                        <li><a href="settings.html" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a></li>
                        <li><a href="reports.html" class="nav-link">
                            <i class="fas fa-file-contract"></i>
                            <span>Reports</span>
                        </a></li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="dashboard-header">
                <div class="header-content">
                    <h1>Contact Messages Management</h1>
                    <p>Manage customer inquiries, support requests, and feedback messages</p>
                </div>
                
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openAddContactModal()">
                        <i class="fas fa-plus"></i> Add Contact Message
                    </button>
                    <button class="btn btn-outline" onclick="exportContacts()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalMessages">0</h3>
                        <p>Total Messages</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="pendingMessages">0</h3>
                        <p>Pending</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="resolvedMessages">0</h3>
                        <p>Resolved</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="fas fa-reply"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="avgResponseTime">24h</h3>
                        <p>Avg Response Time</p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-section">
                <div class="filter-group">
                    <label>Status Filter:</label>
                    <select id="statusFilter" onchange="filterContacts()" title="Filter by Status">
                        <option value="">All Statuses</option>
                        <option value="New">New</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Priority Filter:</label>
                    <select id="priorityFilter" onchange="filterContacts()" title="Filter by Priority">
                        <option value="">All Priorities</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Type Filter:</label>
                    <select id="typeFilter" onchange="filterContacts()" title="Filter by Message Type">
                        <option value="">All Types</option>
                        <option value="General Inquiry">General Inquiry</option>
                        <option value="Technical Support">Technical Support</option>
                        <option value="Course Question">Course Question</option>
                        <option value="Billing Issue">Billing Issue</option>
                        <option value="Feedback">Feedback</option>
                        <option value="Complaint">Complaint</option>
                    </select>
                </div>
            </div>

            <!-- Contact Messages Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">
                        <h2>Contact Messages</h2>
                        <span class="table-count" id="tableCount">0 messages</span>
                    </div>
                    
                    <div class="table-actions">
                        <div class="bulk-actions">
                            <input type="checkbox" id="selectAll">
                            <label for="selectAll">Select All</label>
                            <button class="btn btn-sm btn-outline" onclick="markSelectedAsRead()">
                                <i class="fas fa-eye"></i> Mark as Read
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelected()">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllHeader" title="Select All"></th>
                                <th>Contact Info</th>
                                <th>Subject</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Contact Message</h3>
                <button class="modal-close" onclick="closeAddContactModal()" title="Close Modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form class="modal-body" id="contactForm" onsubmit="handleContactSubmit(event)">
                <input type="hidden" id="contactId" name="contactId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" class="form-control" placeholder="Enter first name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" class="form-control" placeholder="Enter last name" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="email">Email Address</label>
                        <input type="email" id="email" name="email" class="form-control" placeholder="Enter email address" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone" class="form-control" placeholder="Enter phone number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="messageType">Message Type</label>
                        <select id="messageType" name="messageType" class="form-control" required>
                            <option value="">Select type</option>
                            <option value="General Inquiry">General Inquiry</option>
                            <option value="Technical Support">Technical Support</option>
                            <option value="Course Question">Course Question</option>
                            <option value="Billing Issue">Billing Issue</option>
                            <option value="Feedback">Feedback</option>
                            <option value="Complaint">Complaint</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="priority">Priority</label>
                        <select id="priority" name="priority" class="form-control" required>
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="subject">Subject</label>
                    <input type="text" id="subject" name="subject" class="form-control" placeholder="Enter message subject" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="message">Message</label>
                    <textarea id="message" name="message" class="form-control" rows="5" placeholder="Enter your message..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="status">Status</label>
                    <select id="status" name="status" class="form-control" required>
                        <option value="New" selected>New</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddContactModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Contact Details Modal -->
    <div class="modal" id="viewContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Contact Message Details</h3>
                <button class="modal-close" onclick="closeViewContactModal()" title="Close Modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body" id="contactDetails">
                <!-- Contact details will be populated here -->
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeViewContactModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="editFromView()">Edit Contact</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration for API endpoints
        const API_BASE_URL = '../backend/api/contacts.php';
        const USE_DATABASE = true; // Set to true to use database, false for localStorage
        
        // Global variables
        let currentViewContactId = null;
        let allContacts = [];

        // Modal Functions
        function openAddContactModal() {
            document.getElementById('addContactModal').style.display = 'flex';
            document.getElementById('contactForm').reset();
            document.getElementById('modalTitle').textContent = 'Add New Contact Message';
            document.getElementById('contactId').value = '';
        }

        function closeAddContactModal() {
            document.getElementById('addContactModal').style.display = 'none';
        }

        function openEditContactModal(contactId) {
            const contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const contact = contacts.find(c => c.id == contactId);
            
            if (contact) {
                document.getElementById('modalTitle').textContent = 'Edit Contact Message';
                document.getElementById('contactId').value = contact.id;
                document.getElementById('firstName').value = contact.firstName;
                document.getElementById('lastName').value = contact.lastName;
                document.getElementById('email').value = contact.email;
                document.getElementById('phone').value = contact.phone || '';
                document.getElementById('messageType').value = contact.messageType;
                document.getElementById('priority').value = contact.priority;
                document.getElementById('subject').value = contact.subject;
                document.getElementById('message').value = contact.message;
                document.getElementById('status').value = contact.status;
                document.getElementById('addContactModal').style.display = 'flex';
            }
        }

        function viewContact(contactId) {
            const contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const contact = contacts.find(c => c.id == contactId);
            
            if (contact) {
                currentViewContactId = contactId;
                const detailsHtml = `
                    <div class="contact-details-grid">
                        <div class="detail-section">
                            <h4>Contact Information</h4>
                            <div class="detail-item">
                                <label>Name:</label>
                                <span>${contact.firstName} ${contact.lastName}</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span>${contact.email}</span>
                            </div>
                            <div class="detail-item">
                                <label>Phone:</label>
                                <span>${contact.phone || 'Not provided'}</span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Message Details</h4>
                            <div class="detail-item">
                                <label>Type:</label>
                                <span class="badge badge-${contact.messageType.toLowerCase().replace(' ', '-')}">${contact.messageType}</span>
                            </div>
                            <div class="detail-item">
                                <label>Priority:</label>
                                <span class="priority-badge priority-${contact.priority.toLowerCase()}">${contact.priority}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span class="status-badge status-${contact.status.toLowerCase().replace(' ', '-')}">${contact.status}</span>
                            </div>
                            <div class="detail-item">
                                <label>Subject:</label>
                                <span>${contact.subject}</span>
                            </div>
                            <div class="detail-item">
                                <label>Date:</label>
                                <span>${new Date(contact.createdAt).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="detail-section full-width">
                            <h4>Message</h4>
                            <div class="message-content">
                                ${contact.message}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('contactDetails').innerHTML = detailsHtml;
                document.getElementById('viewContactModal').style.display = 'flex';
            }
        }

        function closeViewContactModal() {
            document.getElementById('viewContactModal').style.display = 'none';
            currentViewContactId = null;
        }

        function editFromView() {
            closeViewContactModal();
            if (currentViewContactId) {
                openEditContactModal(currentViewContactId);
            }
        }

        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact message?')) {
                let contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
                contacts = contacts.filter(c => c.id != contactId);
                localStorage.setItem('edumentor_admin_contacts', JSON.stringify(contacts));
                loadContacts();
                updateStats();
                showAlert('Contact message deleted successfully!', 'success');
            }
        }

        function updateContactStatus(contactId, newStatus) {
            let contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const contactIndex = contacts.findIndex(c => c.id == contactId);
            
            if (contactIndex !== -1) {
                contacts[contactIndex].status = newStatus;
                contacts[contactIndex].lastModified = new Date().toISOString();
                if (newStatus === 'Resolved' || newStatus === 'Closed') {
                    contacts[contactIndex].resolvedAt = new Date().toISOString();
                }
                localStorage.setItem('edumentor_admin_contacts', JSON.stringify(contacts));
                loadContacts();
                updateStats();
                showAlert(`Contact status updated to ${newStatus}!`, 'success');
            }
        }

        // Load and display contacts
        async function loadContacts() {
            try {
                if (USE_DATABASE) {
                    await loadContactsFromDatabase();
                } else {
                    loadContactsFromLocalStorage();
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                showAlert('Failed to load contacts. Using offline mode.', 'error');
                loadContactsFromLocalStorage();
            }
        }

        // Load contacts from database
        async function loadContactsFromDatabase() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=list`);
                const result = await response.json();
                
                if (result.success) {
                    allContacts = result.data;
                    displayContacts(allContacts);
                    updateTableCount(allContacts.length);
                    await updateStatsFromDatabase();
                } else {
                    throw new Error(result.error || 'Failed to load contacts');
                }
            } catch (error) {
                console.error('Database load failed:', error);
                throw error;
            }
        }

        // Load contacts from localStorage (fallback)
        function loadContactsFromLocalStorage() {
            const contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            allContacts = contacts;
            displayContacts(contacts);
            updateTableCount(contacts.length);
            updateStats();
        }

        function displayContacts(contacts) {
            const tbody = document.getElementById('contactsTableBody');
            
            if (contacts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-envelope" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                            <p>No contact messages found. <a href="#" onclick="openAddContactModal()">Add your first contact message</a></p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = contacts.map(contact => `
                <tr data-contact-id="${contact.id}">
                    <td><input type="checkbox" class="row-checkbox" value="${contact.id}"></td>
                    <td>
                        <div class="contact-info">
                            <div class="contact-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h4>${contact.firstName} ${contact.lastName}</h4>
                                <p>${contact.email}</p>
                                <span class="contact-id">#C${contact.id.toString().padStart(6, '0')}</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="subject-preview">
                            <span class="subject-text">${contact.subject}</span>
                            <span class="message-preview">${contact.message.substring(0, 60)}...</span>
                        </div>
                    </td>
                    <td><span class="type-badge type-${contact.messageType.toLowerCase().replace(' ', '-')}">${contact.messageType}</span></td>
                    <td><span class="priority-badge priority-${contact.priority.toLowerCase()}">${contact.priority}</span></td>
                    <td><span class="status-badge status-${contact.status.toLowerCase().replace(' ', '-')}">${contact.status}</span></td>
                    <td>${new Date(contact.createdAt).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" title="View Details" onclick="viewContact(${contact.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-edit" title="Edit" onclick="openEditContactModal(${contact.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <div class="dropdown">
                                <button class="btn-action btn-status" title="Update Status" onclick="toggleStatusDropdown(${contact.id})">
                                    <i class="fas fa-flag"></i>
                                </button>
                                <div class="dropdown-menu" id="statusDropdown-${contact.id}">
                                    <button onclick="updateContactStatus(${contact.id}, 'New')">New</button>
                                    <button onclick="updateContactStatus(${contact.id}, 'In Progress')">In Progress</button>
                                    <button onclick="updateContactStatus(${contact.id}, 'Resolved')">Resolved</button>
                                    <button onclick="updateContactStatus(${contact.id}, 'Closed')">Closed</button>
                                </div>
                            </div>
                            <button class="btn-action btn-delete" title="Delete" onclick="deleteContact(${contact.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function toggleStatusDropdown(contactId) {
            const dropdown = document.getElementById(`statusDropdown-${contactId}`);
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function updateTableCount(count) {
            document.getElementById('tableCount').textContent = `${count} message${count !== 1 ? 's' : ''}`;
        }

        // Handle form submission
        async function handleContactSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const contactData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                messageType: formData.get('messageType'),
                priority: formData.get('priority'),
                subject: formData.get('subject'),
                message: formData.get('message'),
                status: formData.get('status')
            };

            // Basic validation
            if (!contactData.firstName || !contactData.lastName || !contactData.email || !contactData.subject || !contactData.message) {
                showAlert('Please fill in all required fields!', 'error');
                return;
            }

            const contactId = formData.get('contactId');
            
            try {
                if (USE_DATABASE) {
                    if (contactId) {
                        await updateContactInDatabase(contactId, contactData);
                    } else {
                        await createContactInDatabase(contactData);
                    }
                } else {
                    if (contactId) {
                        updateContactInLocalStorage(contactId, contactData);
                    } else {
                        createContactInLocalStorage(contactData);
                    }
                }
                
                loadContacts();
                closeAddContactModal();
                
            } catch (error) {
                console.error('Error saving contact:', error);
                showAlert('Failed to save contact. Please try again.', 'error');
            }
        }

        // Create contact in database
        async function createContactInDatabase(contactData) {
            const response = await fetch(`${API_BASE_URL}?action=create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: contactData.firstName,
                    last_name: contactData.lastName,
                    email: contactData.email,
                    phone: contactData.phone,
                    message_type: contactData.messageType,
                    priority: contactData.priority,
                    subject: contactData.subject,
                    message: contactData.message,
                    status: contactData.status
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Failed to create contact');
            }
            
            showAlert('Contact message added successfully!', 'success');
        }

        // Update contact in database
        async function updateContactInDatabase(contactId, contactData) {
            const response = await fetch(`${API_BASE_URL}?action=update&id=${contactId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    first_name: contactData.firstName,
                    last_name: contactData.lastName,
                    email: contactData.email,
                    phone: contactData.phone,
                    message_type: contactData.messageType,
                    priority: contactData.priority,
                    subject: contactData.subject,
                    message: contactData.message,
                    status: contactData.status
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Failed to update contact');
            }
            
            showAlert('Contact message updated successfully!', 'success');
        }

        // Create contact in localStorage (fallback)
        function createContactInLocalStorage(contactData) {
            let contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const newContact = {
                id: Date.now(),
                firstName: contactData.firstName,
                lastName: contactData.lastName,
                email: contactData.email,
                phone: contactData.phone,
                messageType: contactData.messageType,
                priority: contactData.priority,
                subject: contactData.subject,
                message: contactData.message,
                status: contactData.status,
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                isRead: false
            };
            contacts.push(newContact);
            localStorage.setItem('edumentor_admin_contacts', JSON.stringify(contacts));
            showAlert('Contact message added successfully!', 'success');
        }

        // Update contact in localStorage (fallback)
        function updateContactInLocalStorage(contactId, contactData) {
            let contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const contactIndex = contacts.findIndex(c => c.id == contactId);
            
            if (contactIndex !== -1) {
                contacts[contactIndex] = {
                    ...contacts[contactIndex],
                    firstName: contactData.firstName,
                    lastName: contactData.lastName,
                    email: contactData.email,
                    phone: contactData.phone,
                    messageType: contactData.messageType,
                    priority: contactData.priority,
                    subject: contactData.subject,
                    message: contactData.message,
                    status: contactData.status,
                    lastModified: new Date().toISOString()
                };
                localStorage.setItem('edumentor_admin_contacts', JSON.stringify(contacts));
                showAlert('Contact message updated successfully!', 'success');
            }
        }

        // Filter functionality
        function filterContacts() {
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            let contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            
            if (statusFilter) {
                contacts = contacts.filter(c => c.status === statusFilter);
            }
            if (priorityFilter) {
                contacts = contacts.filter(c => c.priority === priorityFilter);
            }
            if (typeFilter) {
                contacts = contacts.filter(c => c.messageType === typeFilter);
            }
            
            displayContacts(contacts);
            updateTableCount(contacts.length);
        }

        // Search functionality
        function searchContacts(searchTerm) {
            const contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const filteredContacts = contacts.filter(contact => 
                contact.firstName.toLowerCase().includes(searchTerm) ||
                contact.lastName.toLowerCase().includes(searchTerm) ||
                contact.email.toLowerCase().includes(searchTerm) ||
                contact.subject.toLowerCase().includes(searchTerm) ||
                contact.message.toLowerCase().includes(searchTerm) ||
                contact.messageType.toLowerCase().includes(searchTerm)
            );
            displayContacts(filteredContacts);
            updateTableCount(filteredContacts.length);
        }

        // Bulk operations
        function markSelectedAsRead() {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showAlert('Please select at least one message!', 'error');
                return;
            }
            
            let contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            contacts = contacts.map(contact => {
                if (selectedIds.includes(contact.id.toString())) {
                    contact.isRead = true;
                    contact.lastModified = new Date().toISOString();
                }
                return contact;
            });
            
            localStorage.setItem('edumentor_admin_contacts', JSON.stringify(contacts));
            loadContacts();
            showAlert(`${selectedIds.length} message(s) marked as read!`, 'success');
        }

        function deleteSelected() {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showAlert('Please select at least one message!', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedIds.length} selected message(s)?`)) {
                let contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
                contacts = contacts.filter(contact => !selectedIds.includes(contact.id.toString()));
                localStorage.setItem('edumentor_admin_contacts', JSON.stringify(contacts));
                loadContacts();
                updateStats();
                showAlert(`${selectedIds.length} message(s) deleted successfully!`, 'success');
            }
        }

        // Export functionality
        function exportContacts() {
            const contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const dataStr = JSON.stringify(contacts, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `contact-messages-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('Contact messages exported successfully!', 'success');
        }

        // Statistics update
        async function updateStatsFromDatabase() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=stats`);
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalMessages').textContent = stats.total_messages || 0;
                    document.getElementById('pendingMessages').textContent = stats.pending_messages || 0;
                    document.getElementById('resolvedMessages').textContent = stats.resolved_messages || 0;
                    document.getElementById('avgResponseTime').textContent = stats.avg_response_time || 'N/A';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                updateStats(); // Fallback to localStorage stats
            }
        }

        function updateStats() {
            const contacts = JSON.parse(localStorage.getItem('edumentor_admin_contacts') || '[]');
            const totalMessages = contacts.length;
            const pendingMessages = contacts.filter(c => c.status === 'New' || c.status === 'In Progress').length;
            const resolvedMessages = contacts.filter(c => c.status === 'Resolved' || c.status === 'Closed').length;
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('pendingMessages').textContent = pendingMessages;
            document.getElementById('resolvedMessages').textContent = resolvedMessages;
        }

        // Alert system
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer') || createAlertContainer();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; float: right;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function createAlertContainer() {
            const container = document.createElement('div');
            container.id = 'alertContainer';
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
            `;
            document.body.appendChild(container);
            return container;
        }

        // Initialize sample data
        function initializeSampleData() {
            const existingContacts = localStorage.getItem('edumentor_admin_contacts');
            if (!existingContacts) {
                const sampleContacts = [
                    {
                        id: 1,
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'john.doe@example.com',
                        phone: '+1234567890',
                        messageType: 'Technical Support',
                        priority: 'High',
                        subject: 'Login Issues',
                        message: 'I am unable to login to my account. Keep getting error messages when I try to access the platform.',
                        status: 'New',
                        createdAt: '2024-07-20T10:30:00Z',
                        isRead: false
                    },
                    {
                        id: 2,
                        firstName: 'Jane',
                        lastName: 'Smith',
                        email: 'jane.smith@example.com',
                        phone: '+1234567891',
                        messageType: 'Course Question',
                        priority: 'Medium',
                        subject: 'Course Materials Access',
                        message: 'Can you please help me access the course materials for JavaScript Fundamentals? I cannot find the download links.',
                        status: 'In Progress',
                        createdAt: '2024-07-19T14:15:00Z',
                        isRead: true
                    },
                    {
                        id: 3,
                        firstName: 'Mike',
                        lastName: 'Johnson',
                        email: 'mike.johnson@example.com',
                        messageType: 'General Inquiry',
                        priority: 'Low',
                        subject: 'Course Recommendations',
                        message: 'I am new to programming and would like to know which courses you would recommend for a complete beginner.',
                        status: 'Resolved',
                        createdAt: '2024-07-18T09:45:00Z',
                        resolvedAt: '2024-07-19T11:30:00Z',
                        isRead: true
                    },
                    {
                        id: 4,
                        firstName: 'Sarah',
                        lastName: 'Wilson',
                        email: 'sarah.wilson@example.com',
                        phone: '+1234567892',
                        messageType: 'Billing Issue',
                        priority: 'Urgent',
                        subject: 'Payment Not Processed',
                        message: 'I made a payment yesterday but my account still shows as unpaid. Can you please check this urgently?',
                        status: 'New',
                        createdAt: '2024-07-21T08:20:00Z',
                        isRead: false
                    },
                    {
                        id: 5,
                        firstName: 'David',
                        lastName: 'Brown',
                        email: 'david.brown@example.com',
                        messageType: 'Feedback',
                        priority: 'Low',
                        subject: 'Great Platform!',
                        message: 'Just wanted to say thank you for creating such an amazing learning platform. The courses are well-structured and easy to follow.',
                        status: 'Closed',
                        createdAt: '2024-07-17T16:00:00Z',
                        resolvedAt: '2024-07-18T09:00:00Z',
                        isRead: true
                    }
                ];
                localStorage.setItem('edumentor_admin_contacts', JSON.stringify(sampleContacts));
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sample data and load contacts
            initializeSampleData();
            loadContacts();
            updateStats();

            // Setup search functionality
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    searchContacts(searchTerm);
                });
            }

            // Setup select all functionality
            const selectAllCheckbox = document.getElementById('selectAll');
            const selectAllHeader = document.getElementById('selectAllHeader');
            
            function updateSelectAllState() {
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
                const allSelected = rowCheckboxes.length > 0 && checkedBoxes.length === rowCheckboxes.length;
                const someSelected = checkedBoxes.length > 0 && checkedBoxes.length < rowCheckboxes.length;
                
                [selectAllCheckbox, selectAllHeader].forEach(checkbox => {
                    if (checkbox) {
                        checkbox.checked = allSelected;
                        checkbox.indeterminate = someSelected;
                    }
                });
            }

            [selectAllCheckbox, selectAllHeader].forEach(checkbox => {
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                        rowCheckboxes.forEach(cb => {
                            cb.checked = this.checked;
                        });
                    });
                }
            });

            // Update select all state when individual checkboxes change
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('row-checkbox')) {
                    updateSelectAllState();
                }
            });

            // Modal close on background click
            ['addContactModal', 'viewContactModal'].forEach(modalId => {
                document.getElementById(modalId).addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                }
            });
        });
    </script>

    <style>
        /* Contact-specific styles */
        .contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        .subject-preview {
            max-width: 250px;
        }

        .subject-text {
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .message-preview {
            font-size: 0.875rem;
            color: #6c757d;
            display: block;
        }

        .type-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .type-general-inquiry { background: #e3f2fd; color: #1976d2; }
        .type-technical-support { background: #fce4ec; color: #c2185b; }
        .type-course-question { background: #f3e5f5; color: #7b1fa2; }
        .type-billing-issue { background: #fff3e0; color: #f57c00; }
        .type-feedback { background: #e8f5e8; color: #388e3c; }
        .type-complaint { background: #ffebee; color: #d32f2f; }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-low { background: #e8f5e8; color: #388e3c; }
        .priority-medium { background: #fff3e0; color: #f57c00; }
        .priority-high { background: #ffebee; color: #d32f2f; }
        .priority-urgent { background: #ffebee; color: #b71c1c; animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-in-progress { background: #fff3e0; color: #f57c00; }
        .status-resolved { background: #e8f5e8; color: #388e3c; }
        .status-closed { background: #f5f5f5; color: #757575; }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background: white;
            min-width: 120px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 4px;
            z-index: 1000;
            right: 0;
            top: 100%;
        }

        .dropdown-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .dropdown-menu button:hover {
            background: #f8f9fa;
        }

        .filters-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 500;
            font-size: 0.875rem;
            color: #495057;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .contact-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
        }

        .detail-section.full-width {
            grid-column: 1 / -1;
        }

        .detail-section h4 {
            margin-bottom: 12px;
            color: #495057;
            font-size: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item label {
            font-weight: 500;
            color: #6c757d;
        }

        .message-content {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .filters-section {
                flex-direction: column;
                gap: 12px;
            }

            .contact-details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
